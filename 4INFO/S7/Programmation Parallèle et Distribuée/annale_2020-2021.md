
# Programmation Parallèle et Distribuée, décembre 2020

## Exercice 1

Code de la bibliothèque :
```java
public interface Library extends Remote {
    long nbBooksYear(int year) throws RemoteException;
    Book getBook(int id) throws RemoteException;
    Account getAccountInfo(int id) throws RemoteException;
}

public class LibraryImpl extends UnicastRemoteObject implements Library {

    private static int NEXT_ID_BOOKS = 1;
    private static int NEXT_ID_ACCOUNTS = 1;

    private final Map<Integer, Book> books;
    private final Map<Integer, Account> accounts;

    public LibraryImpl(int port) throws RemoteException {
        super(port);
        books = new HashMap<>();
        accounts = new HashMap<>();
    }

    public int addBook(Book b) {
        books.put(NEXT_ID_BOOKS, b);
        return NEXT_ID_BOOKS++;
    }

    public int addAccount(Account a) {
        accounts.put(NEXT_ID_ACCOUNTS, a);
        return NEXT_ID_ACCOUNTS++;
    }

    @Override
    public long nbBooksYear(int year) {
        return books.values().stream()
                .filter(b -> {
                    try {
                        return b.getYear() == year;
                    } catch (RemoteException e) {
                        e.printStackTrace();
                    }
                    return false;
                })
                .count();
    }

    @Override
    public Book getBook(int id) {
        Book res = books.get(id);
        if(res == null) {
            throw new IllegalArgumentException("Book " + id + " does not exist");
        }
        return res;
    }

    @Override
    public Account getAccountInfo(int id) {
        Account res = accounts.get(id);
        if(res == null) {
            throw new IllegalArgumentException("Account " + id + " does not exist");
        }
        return res;
    }
}
```

Code du livre (passé par référence car peut contenir beaucoup de données) :
```java
public interface Book extends Remote {
    int getYear() throws RemoteException;
    String getAuthor() throws RemoteException;
    String getTitle() throws RemoteException;
    String getPage(int nb) throws RemoteException;
    String getBookRef() throws RemoteException;
}

public class BookImpl extends UnicastRemoteObject implements Book {

    private final int year;
    private final String author;
    private final String title;
    private final List<String> pages;

    public BookImpl(int y, String a, String t, Collection<String> p) throws RemoteException {
        super();
        year = y;
        author = a;
        title = t;
        pages = new ArrayList<>(p);
    }

    @Override
    public int getYear() {
        return year;
    }

    @Override
    public String getAuthor() {
        return author;
    }

    @Override
    public String getTitle() {
        return title;
    }

    @Override
    public String getPage(int nb) {
        if(nb >= pages.size() || nb < 0) {
            throw new IllegalArgumentException("Book \"" + title + "\" has " + pages.size() + " pages");
        }
        return pages.get(nb);
    }

    @Override
    public String getBookRef() {
        return title + " (" + author + ", " + year + ")";
    }

    @Override
    public String toString() {
        return getBookRef();
    }
}
```

Code du compte client (passé par valeur car on ne veut pas que le client puisse modifier les données, seulement les consulter) :
```java
public class Account implements Serializable {

    private final String name;
    private Date validUntil;

    public Account(String n, Date end) {
        name = n;
        validUntil = end;
    }

    public String getName() {
        return name;
    }

    public void setValidity(Date end) {
        validUntil = end;
    }

}
```

Code de test du serveur :
```java
public class Server {

    public static void main(final String[] args) throws UnknownHostException, RemoteException, AlreadyBoundException, MalformedURLException {
        String serverAddr = InetAddress.getLocalHost().getHostAddress();
        String libUrl = "rmi://" + serverAddr + ":50100/library";
        LibraryImpl library = new LibraryImpl(50000);
        library.addBook(new BookImpl(2021, "Nicolas SARKOZY", "Le Temps des Tempêtes", List.of("Page 1", "Page 2")));
        library.addAccount(new Account("Antoine DANIEL", new GregorianCalendar(2022, Calendar.MARCH, 14).getTime()));
        LocateRegistry.createRegistry(50100);
        Naming.bind(libUrl, library);
    }

}
```

Code de test du client :
```java
public class Client {

    public static void main(final String[] args) throws UnknownHostException, RemoteException, NotBoundException, MalformedURLException {
        String serverAddr = InetAddress.getLocalHost().getHostAddress();
        String libUrl = "rmi://" + serverAddr + ":50100/library";
        Library library = (Library) Naming.lookup(libUrl);
        System.out.println(library.nbBooksYear(2020));
        System.out.println(library.nbBooksYear(2021));
        // We can't use System.out.println(library.getBook(1).toString()) as it yields :
        // Proxy[Book,RemoteObjectInvocationHandler[UnicastRef [liveRef: [endpoint:[127.0.1.1:33183](remote),objID:[-49ddc120:17cdcbcadff:-7ffe, 5502718772787261324]]]]]
        System.out.println(library.getBook(1).getBookRef());
        System.out.println(library.getAccountInfo(1).getName());
        try {
            System.out.println(library.getBook(1).getPage(-1));
        } catch (IllegalArgumentException e) {
            e.printStackTrace();
        }
        System.exit(0);
    }

}
```
